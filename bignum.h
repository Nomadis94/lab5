/**
 * \file bignum.h
 *
 * Описание:  Multi-precision integer library
 *
 *  Copyright (C) 2006-2010, Brainspark B.V.
 *
 *  This file is part of PolarSSL (http://www.polarssl.org)
 *  Lead Maintainer: Paul Bakker <polarssl_maintainer at polarssl.org>
 *
 *  All rights reserved.
 *
 *  This program is free software; you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation; either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along
 *  with this program; if not, write to the Free Software Foundation, Inc.,
 *  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
 */
#ifndef POLARSSL_BIGNUM_H
#define POLARSSL_BIGNUM_H

#include <stdio.h>
#include <string.h>

#include "config.h"

#define POLARSSL_ERR_MPI_FILE_IO_ERROR                     -0x0002  /**< An error occurred while reading from or writing to a file. */
#define POLARSSL_ERR_MPI_BAD_INPUT_DATA                    -0x0004  /**< Bad input parameters to function. */
#define POLARSSL_ERR_MPI_INVALID_CHARACTER                 -0x0006  /**< There is an invalid character in the digit string. */
#define POLARSSL_ERR_MPI_BUFFER_TOO_SMALL                  -0x0008  /**< The buffer is too small to write to. */
#define POLARSSL_ERR_MPI_NEGATIVE_VALUE                    -0x000A  /**< The input arguments are negative or result in illegal output. */
#define POLARSSL_ERR_MPI_DIVISION_BY_ZERO                  -0x000C  /**< The input argument for division is zero, which is not allowed. */
#define POLARSSL_ERR_MPI_NOT_ACCEPTABLE                    -0x000E  /**< The input arguments are not acceptable. */
#define POLARSSL_ERR_MPI_MALLOC_FAILED                     -0x0010  /**< Memory allocation failed. */

#define MPI_CHK(f) if( ( ret = f ) != 0 ) goto cleanup

/*
 * Maximum size MPIs are allowed to grow to in number of limbs.
 */
#define POLARSSL_MPI_MAX_LIMBS                             10000

/*
 * Maximum window size used for modular exponentiation. Default: 6
 * Minimum value: 1. Maximum value: 6.
 *
 * Result is an array of ( 2 << POLARSSL_MPI_WINDOW_SIZE ) MPIs used
 * for the sliding window calculation. (So 64 by default)
 *
 * Reduction in size, reduces speed.
 */
#define POLARSSL_MPI_WINDOW_SIZE                           6        /**< Maximum windows size used. */

/*
 * Maximum size of MPIs allowed in bits and bytes for user-MPIs.
 * ( Default: 512 bytes => 4096 bits )
 *
 * Note: Calculations can results temporarily in larger MPIs. So the number
 * of limbs required (POLARSSL_MPI_MAX_LIMBS) is higher.
 */
#define POLARSSL_MPI_MAX_SIZE                              512      /**< Maximum number of bytes for usable MPIs. */
#define POLARSSL_MPI_MAX_BITS                              ( 8 * POLARSSL_MPI_MAX_SIZE )    /**< Maximum number of bits for usable MPIs. */

/*
 * When reading from files with mpi_read_file() the buffer should have space
 * for a (short) label, the MPI (in the provided radix), the newline
 * characters and the '\0'.
 *
 * By default we assume at least a 10 char label, a minimum radix of 10
 * (decimal) and a maximum of 4096 bit numbers (1234 decimal chars).
 */
#define POLARSSL_MPI_READ_BUFFER_SIZE                       1250   

/*
 * Define the base integer type, architecture-wise
 */
#if defined(POLARSSL_HAVE_INT8)
typedef   signed char  t_sint;
typedef unsigned char  t_uint;
typedef unsigned short t_udbl;
#else
#if defined(POLARSSL_HAVE_INT16)
typedef   signed short t_sint;
typedef unsigned short t_uint;
typedef unsigned long  t_udbl;
#else
  typedef   signed long t_sint;
  typedef unsigned long t_uint;
  #if defined(_MSC_VER) && defined(_M_IX86)
  typedef unsigned __int64 t_udbl;
  #else
    #if defined(__GNUC__) && (                          \
        defined(__amd64__) || defined(__x86_64__)    || \
        defined(__ppc64__) || defined(__powerpc64__) || \
        defined(__ia64__)  || defined(__alpha__)     || \
        (defined(__sparc__) && defined(__arch64__))  || \
        defined(__s390x__) )
    typedef unsigned int t_udbl __attribute__((mode(TI)));
    #define POLARSSL_HAVE_LONGLONG
    #else
      #if defined(POLARSSL_HAVE_LONGLONG)
      typedef unsigned long long t_udbl;
      #endif
    #endif
  #endif
#endif
#endif

/**
 * Описание:          MPI structure
 */
typedef struct
{
    int s;              /*!<  integer sign      */
    size_t n;           /*!<  total # of limbs  */
    t_uint *p;          /*!<  pointer to limbs  */
}
mpi;

#ifdef __cplusplus
extern "C" {
#endif

/**
 * Описание:           Initialize one MPI
 *
 * Парам. X         One MPI to initialize.
 */
void mpi_init( mpi *X );

/**
 * Описание:          Unallocate one MPI
 *
 * Парам. X        One MPI to unallocate.
 */
void mpi_free( mpi *X );

/**
 * Описание:          Enlarge to the specified number of limbs
 *
 * Парам. X        MPI to grow
 * Парам. nblimbs  The target number of limbs
 *
 * Возвр. :         0 if successful,
 *                 POLARSSL_ERR_MPI_MALLOC_FAILED if memory allocation failed
 */
int mpi_grow( mpi *X, size_t nblimbs );

/**
 * Описание:          Copy the contents of Y into X
 *
 * Парам. X        Destination MPI
 * Парам. Y        Source MPI
 *
 * Возвр. :         0 if successful,
 *                 POLARSSL_ERR_MPI_MALLOC_FAILED if memory allocation failed
 */
int mpi_copy( mpi *X, const mpi *Y );

/**
 * Описание:          Swap the contents of X and Y
 *
 * Парам. X        First MPI value
 * Парам. Y        Second MPI value
 */
void mpi_swap( mpi *X, mpi *Y );

/**
 * Описание:          Set value from integer
 *
 * Парам. X        MPI to set
 * Парам. z        Value to use
 *
 * Возвр. :         0 if successful,
 *                 POLARSSL_ERR_MPI_MALLOC_FAILED if memory allocation failed
 */
int mpi_lset( mpi *X, t_sint z );

/*
 * Описание:          Get a specific bit from X
 *
 * Парам. X        MPI to use
 * Парам. pos      Zero-based index of the bit in X
 *
 * Возвр. :         Either a 0 or a 1
 */
int mpi_get_bit( mpi *X, size_t pos );

/*
 * Описание:          Set a bit of X to a specific value of 0 or 1
 *
 * Допол.:        Will grow X if necessary to set a bit to 1 in a not yet
 *                 existing limb. Will not grow if bit should be set to 0
 *
 * Парам. X        MPI to use
 * Парам. pos      Zero-based index of the bit in X
 * Парам. val      The value to set the bit to (0 or 1)
 *
 * Возвр. :         0 if successful,
 *                 POLARSSL_ERR_MPI_MALLOC_FAILED if memory allocation failed,
 *                 POLARSSL_ERR_MPI_BAD_INPUT_DATA if val is not 0 or 1
 */
int mpi_set_bit( mpi *X, size_t pos, unsigned char val );

/**
 * Описание:          Return the number of least significant bits
 *
 * Парам. X        MPI to use
 */
size_t mpi_lsb( const mpi *X );

/**
 * Описание:          Return the number of most significant bits
 *
 * Парам. X        MPI to use
 */
size_t mpi_msb( const mpi *X );

/**
 * Описание:          Return the total size in bytes
 *
 * Парам. X        MPI to use
 */
size_t mpi_size( const mpi *X );

/**
 * Описание:          Import from an ASCII string
 *
 * Парам. X        Destination MPI
 * Парам. radix    Input numeric base
 * Парам. s        Null-terminated string buffer
 *
 * Возвр. :         0 if successful, or a POLARSSL_ERR_MPI_XXX error code
 */
int mpi_read_string( mpi *X, int radix, const char *s );

/**
 * Описание:          Export into an ASCII string
 *
 * Парам. X        Source MPI
 * Парам. radix    Output numeric base
 * Парам. s        String buffer
 * Парам. slen     String buffer size
 *
 * Возвр. :         0 if successful, or a POLARSSL_ERR_MPI_XXX error code.
 *                 *slen is always updated to reflect the amount
 *                 of data that has (or would have) been written.
 *
 * Допол.:        Call this function with *slen = 0 to obtain the
 *                 minimum required buffer size in *slen.
 */
int mpi_write_string( const mpi *X, int radix, char *s, size_t *slen );

/**
 * Описание:          Read X from an opened file
 *
 * Парам. X        Destination MPI
 * Парам. radix    Input numeric base
 * Парам. fin      Input file handle
 *
 * Возвр. :         0 if successful, POLARSSL_ERR_MPI_BUFFER_TOO_SMALL if
 *                 the file read buffer is too small or a
 *                 POLARSSL_ERR_MPI_XXX error code
 */
int mpi_read_file( mpi *X, int radix, FILE *fin );

/**
 * Описание:          Write X into an opened file, or stdout if fout is NULL
 *
 * Парам. p        Prefix, can be NULL
 * Парам. X        Source MPI
 * Парам. radix    Output numeric base
 * Парам. fout     Output file handle (can be NULL)
 *
 * Возвр. :         0 if successful, or a POLARSSL_ERR_MPI_XXX error code
 *
 * Допол.:        Set fout == NULL to print X on the console.
 */
int mpi_write_file( const char *p, const mpi *X, int radix, FILE *fout );

/**
 * Описание:          Import X from unsigned binary data, big endian
 *
 * Парам. X        Destination MPI
 * Парам. buf      Input buffer
 * Парам. buflen   Input buffer size
 *
 * Возвр. :         0 if successful,
 *                 POLARSSL_ERR_MPI_MALLOC_FAILED if memory allocation failed
 */
int mpi_read_binary( mpi *X, const unsigned char *buf, size_t buflen );

/**
 * Описание:          Export X into unsigned binary data, big endian
 *
 * Парам. X        Source MPI
 * Парам. buf      Output buffer
 * Парам. buflen   Output buffer size
 *
 * Возвр. :         0 if successful,
 *                 POLARSSL_ERR_MPI_BUFFER_TOO_SMALL if buf isn't large enough
 */
int mpi_write_binary( const mpi *X, unsigned char *buf, size_t buflen );

/**
 * Описание:          Left-shift: X <<= count
 *
 * Парам. X        MPI to shift
 * Парам. count    Amount to shift
 *
 * Возвр. :         0 if successful,
 *                 POLARSSL_ERR_MPI_MALLOC_FAILED if memory allocation failed
 */
int mpi_shift_l( mpi *X, size_t count );

/**
 * Описание:          Right-shift: X >>= count
 *
 * Парам. X        MPI to shift
 * Парам. count    Amount to shift
 *
 * Возвр. :         0 if successful,
 *                 POLARSSL_ERR_MPI_MALLOC_FAILED if memory allocation failed
 */
int mpi_shift_r( mpi *X, size_t count );

/**
 * Описание:          Compare unsigned values
 *
 * Парам. X        Left-hand MPI
 * Парам. Y        Right-hand MPI
 *
 * Возвр. :         1 if |X| is greater than |Y|,
 *                -1 if |X| is lesser  than |Y| or
 *                 0 if |X| is equal to |Y|
 */
int mpi_cmp_abs( const mpi *X, const mpi *Y );

/**
 * Описание:          Compare signed values
 *
 * Парам. X        Left-hand MPI
 * Парам. Y        Right-hand MPI
 *
 * Возвр. :         1 if X is greater than Y,
 *                -1 if X is lesser  than Y or
 *                 0 if X is equal to Y
 */
int mpi_cmp_mpi( const mpi *X, const mpi *Y );

/**
 * Описание:          Compare signed values
 *
 * Парам. X        Left-hand MPI
 * Парам. z        The integer value to compare to
 *
 * Возвр. :         1 if X is greater than z,
 *                -1 if X is lesser  than z or
 *                 0 if X is equal to z
 */
int mpi_cmp_int( const mpi *X, t_sint z );

/**
 * Описание:          Unsigned addition: X = |A| + |B|
 *
 * Парам. X        Destination MPI
 * Парам. A        Left-hand MPI
 * Парам. B        Right-hand MPI
 *
 * Возвр. :         0 if successful,
 *                 POLARSSL_ERR_MPI_MALLOC_FAILED if memory allocation failed
 */
int mpi_add_abs( mpi *X, const mpi *A, const mpi *B );

/**
 * Описание:          Unsigned substraction: X = |A| - |B|
 *
 * Парам. X        Destination MPI
 * Парам. A        Left-hand MPI
 * Парам. B        Right-hand MPI
 *
 * Возвр. :         0 if successful,
 *                 POLARSSL_ERR_MPI_NEGATIVE_VALUE if B is greater than A
 */
int mpi_sub_abs( mpi *X, const mpi *A, const mpi *B );

/**
 * Описание:          Signed addition: X = A + B
 *
 * Парам. X        Destination MPI
 * Парам. A        Left-hand MPI
 * Парам. B        Right-hand MPI
 *
 * Возвр. :         0 if successful,
 *                 POLARSSL_ERR_MPI_MALLOC_FAILED if memory allocation failed
 */
int mpi_add_mpi( mpi *X, const mpi *A, const mpi *B );

/**
 * Описание:          Signed substraction: X = A - B
 *
 * Парам. X        Destination MPI
 * Парам. A        Left-hand MPI
 * Парам. B        Right-hand MPI
 *
 * Возвр. :         0 if successful,
 *                 POLARSSL_ERR_MPI_MALLOC_FAILED if memory allocation failed
 */
int mpi_sub_mpi( mpi *X, const mpi *A, const mpi *B );

/**
 * Описание:          Signed addition: X = A + b
 *
 * Парам. X        Destination MPI
 * Парам. A        Left-hand MPI
 * Парам. b        The integer value to add
 *
 * Возвр. :         0 if successful,
 *                 POLARSSL_ERR_MPI_MALLOC_FAILED if memory allocation failed
 */
int mpi_add_int( mpi *X, const mpi *A, t_sint b );

/**
 * Описание:          Signed substraction: X = A - b
 *
 * Парам. X        Destination MPI
 * Парам. A        Left-hand MPI
 * Парам. b        The integer value to subtract
 *
 * Возвр. :         0 if successful,
 *                 POLARSSL_ERR_MPI_MALLOC_FAILED if memory allocation failed
 */
int mpi_sub_int( mpi *X, const mpi *A, t_sint b );

/**
 * Описание:          Baseline multiplication: X = A * B
 *
 * Парам. X        Destination MPI
 * Парам. A        Left-hand MPI
 * Парам. B        Right-hand MPI
 *
 * Возвр. :         0 if successful,
 *                 POLARSSL_ERR_MPI_MALLOC_FAILED if memory allocation failed
 */
int mpi_mul_mpi( mpi *X, const mpi *A, const mpi *B );

/**
 * Описание:          Baseline multiplication: X = A * b
 *                 Note: b is an unsigned integer type, thus
 *                 Negative values of b are ignored.
 *
 * Парам. X        Destination MPI
 * Парам. A        Left-hand MPI
 * Парам. b        The integer value to multiply with
 *
 * Возвр. :         0 if successful,
 *                 POLARSSL_ERR_MPI_MALLOC_FAILED if memory allocation failed
 */
int mpi_mul_int( mpi *X, const mpi *A, t_sint b );

/**
 * Описание:          Division by mpi: A = Q * B + R
 *
 * Парам. Q        Destination MPI for the quotient
 * Парам. R        Destination MPI for the rest value
 * Парам. A        Left-hand MPI
 * Парам. B        Right-hand MPI
 *
 * Возвр. :         0 if successful,
 *                 POLARSSL_ERR_MPI_MALLOC_FAILED if memory allocation failed,
 *                 POLARSSL_ERR_MPI_DIVISION_BY_ZERO if B == 0
 *
 * Допол.:        Either Q or R can be NULL.
 */
int mpi_div_mpi( mpi *Q, mpi *R, const mpi *A, const mpi *B );

/**
 * Описание:          Division by int: A = Q * b + R
 *
 * Парам. Q        Destination MPI for the quotient
 * Парам. R        Destination MPI for the rest value
 * Парам. A        Left-hand MPI
 * Парам. b        Integer to divide by
 *
 * Возвр. :         0 if successful,
 *                 POLARSSL_ERR_MPI_MALLOC_FAILED if memory allocation failed,
 *                 POLARSSL_ERR_MPI_DIVISION_BY_ZERO if b == 0
 *
 * Допол.:        Either Q or R can be NULL.
 */
int mpi_div_int( mpi *Q, mpi *R, const mpi *A, t_sint b );

/**
 * Описание:          Modulo: R = A mod B
 *
 * Парам. R        Destination MPI for the rest value
 * Парам. A        Left-hand MPI
 * Парам. B        Right-hand MPI
 *
 * Возвр. :         0 if successful,
 *                 POLARSSL_ERR_MPI_MALLOC_FAILED if memory allocation failed,
 *                 POLARSSL_ERR_MPI_DIVISION_BY_ZERO if B == 0,
 *                 POLARSSL_ERR_MPI_NEGATIVE_VALUE if B < 0
 */
int mpi_mod_mpi( mpi *R, const mpi *A, const mpi *B );

/**
 * Описание:          Modulo: r = A mod b
 *
 * Парам. r        Destination t_uint
 * Парам. A        Left-hand MPI
 * Парам. b        Integer to divide by
 *
 * Возвр. :         0 if successful,
 *                 POLARSSL_ERR_MPI_MALLOC_FAILED if memory allocation failed,
 *                 POLARSSL_ERR_MPI_DIVISION_BY_ZERO if b == 0,
 *                 POLARSSL_ERR_MPI_NEGATIVE_VALUE if b < 0
 */
int mpi_mod_int( t_uint *r, const mpi *A, t_sint b );

/**
 * Описание:          Sliding-window exponentiation: X = A^E mod N
 *
 * Парам. X        Destination MPI 
 * Парам. A        Left-hand MPI
 * Парам. E        Exponent MPI
 * Парам. N        Modular MPI
 * Парам. _RR      Speed-up MPI used for recalculations
 *
 * Возвр. :         0 if successful,
 *                 POLARSSL_ERR_MPI_MALLOC_FAILED if memory allocation failed,
 *                 POLARSSL_ERR_MPI_BAD_INPUT_DATA if N is negative or even
 *
 * Допол.:        _RR is used to avoid re-computing R*R mod N across
 *                 multiple calls, which speeds up things a bit. It can
 *                 be set to NULL if the extra performance is unneeded.
 */
int mpi_exp_mod( mpi *X, const mpi *A, const mpi *E, const mpi *N, mpi *_RR );

/**
 * Описание:          Fill an MPI X with size bytes of random
 *
 * Парам. X        Destination MPI
 * Парам. size     Size in bytes
 * Парам. f_rng    RNG function
 * Парам. p_rng    RNG parameter
 *
 * Возвр. :         0 if successful,
 *                 POLARSSL_ERR_MPI_MALLOC_FAILED if memory allocation failed
 */
int mpi_fill_random( mpi *X, size_t size,
                     int (*f_rng)(void *, unsigned char *, size_t),
                     void *p_rng );

/**
 * Описание:          Greatest common divisor: G = gcd(A, B)
 *
 * Парам. G        Destination MPI
 * Парам. A        Left-hand MPI
 * Парам. B        Right-hand MPI
 *
 * Возвр. :         0 if successful,
 *                 POLARSSL_ERR_MPI_MALLOC_FAILED if memory allocation failed
 */
int mpi_gcd( mpi *G, const mpi *A, const mpi *B );

/**
 * Описание:          Modular inverse: X = A^-1 mod N
 *
 * Парам. X        Destination MPI
 * Парам. A        Left-hand MPI
 * Парам. N        Right-hand MPI
 *
 * Возвр. :         0 if successful,
 *                 POLARSSL_ERR_MPI_MALLOC_FAILED if memory allocation failed,
 *                 POLARSSL_ERR_MPI_BAD_INPUT_DATA if N is negative or nil
                   POLARSSL_ERR_MPI_NOT_ACCEPTABLE if A has no inverse mod N
 */
int mpi_inv_mod( mpi *X, const mpi *A, const mpi *N );

/**
 * Описание:          Miller-Rabin primality test
 *
 * Парам. X        MPI to check
 * Парам. f_rng    RNG function
 * Парам. p_rng    RNG parameter
 *
 * Возвр. :         0 if successful (probably prime),
 *                 POLARSSL_ERR_MPI_MALLOC_FAILED if memory allocation failed,
 *                 POLARSSL_ERR_MPI_NOT_ACCEPTABLE if X is not prime
 */
int mpi_is_prime( mpi *X,
                  int (*f_rng)(void *, unsigned char *, size_t),
                  void *p_rng );

/**
 * Описание:          Prime number generation
 *
 * Парам. X        Destination MPI
 * Парам. nbits    Required size of X in bits ( 3 <= nbits <= POLARSSL_MPI_MAX_BITS )
 * Парам. dh_flag  If 1, then (X-1)/2 will be prime too
 * Парам. f_rng    RNG function
 * Парам. p_rng    RNG parameter
 *
 * Возвр. :         0 if successful (probably prime),
 *                 POLARSSL_ERR_MPI_MALLOC_FAILED if memory allocation failed,
 *                 POLARSSL_ERR_MPI_BAD_INPUT_DATA if nbits is < 3
 */
int mpi_gen_prime( mpi *X, size_t nbits, int dh_flag,
                   int (*f_rng)(void *, unsigned char *, size_t),
                   void *p_rng );

/**
 * Описание:          Checkup routine
 *
 * Возвр. :         0 if successful, or 1 if the test failed
 */
int mpi_self_test( int verbose );

#ifdef __cplusplus
}
#endif

#endif /* bignum.h */
